<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Registro de Asistencias - TOKTOK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0072ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Estilos -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #e6fff2;
      margin: 0;
      padding: 0;
      position: relative;
      min-height: 100vh;
    }
    
    .lock-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: transform 0.5s ease;
    }
    
    .lock-screen.hidden {
      transform: translateY(-100%);
    }
    
    .lock-icon {
      font-size: 50px;
      color: white;
      margin-bottom: 20px;
    }
    
    .pin-display {
      width: 200px;
      height: 50px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      letter-spacing: 10px;
      padding-right: 10px;
      color: white;
    }
    
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 250px;
    }
    
    .numpad button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .numpad button:active {
      background: rgba(255, 255, 255, 0.4);
    }
    
    .delete-btn {
      grid-column: span 3;
      width: 100% !important;
      border-radius: 10px !important;
      margin-top: 10px;
    }
    
    header {
      background: linear-gradient(to right, #00c6ff, #0072ff);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .container {
      display: flex;
      justify-content: space-around;
      margin: 20px;
      flex-wrap: wrap;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 45%;
      min-width: 350px;
      margin-bottom: 20px;
    }
    
    #reader {
      width: 100%;
      min-height: 350px;
      border: 2px solid #0072ff;
      border-radius: 10px;
      position: relative;
    }
    
    .scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
      z-index: 10;
      border-radius: 10px;
      display: none;
    }
    
    #resultado {
      font-size: 18px;
      color: green;
      margin-top: 10px;
      font-weight: bold;
    }
    
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      background: #0072ff;
      color: white;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    select, input {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px 0;
      width: 100%;
    }
    
    .form-group {
      margin: 10px 0;
    }
    
    .worker-info {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
    }
    
    .error {
      color: red;
      font-weight: bold;
    }
    
    .success {
      color: green;
      font-weight: bold;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,114,255,.3);
      border-radius: 50%;
      border-top-color: #0072ff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .extra-time-controls {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 10px;
      text-align: center;
    }
    
    .extra-time-info {
      font-size: 16px;
      margin: 10px 0;
      padding: 10px;
      background: #e8f4ff;
      border-radius: 8px;
    }
    
    /* Panel flotante para trabajador */
    .worker-floating-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 90%;
      max-width: 400px;
      display: none;
    }
    
    .worker-floating-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .worker-floating-photo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      border: 2px solid #0072ff;
    }
    
    .worker-floating-details {
      flex: 1;
    }
    
    .worker-floating-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .worker-floating-info {
      font-size: 14px;
      color: #555;
    }
    
    .worker-floating-controls {
      margin-top: 15px;
    }
    
    .close-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 16px;
    }
    
    /* Overlay para el panel flotante */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
    
    /* Mensaje flotante de registro */
    .floating-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      font-size: 20px;
      font-weight: bold;
      z-index: 1100;
      display: none;
      text-align: center;
    }
    
    /* Responsividad para m√≥viles */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        margin: 10px;
      }
      
      .card {
        width: 100%;
        min-width: unset;
        margin-bottom: 15px;
        padding: 15px;
      }
      
      #reader {
        min-height: 250px;
      }
      
      header {
        padding: 12px;
        font-size: 18px;
      }
      
      button {
        width: 100%;
        margin: 5px 0;
      }
      
      .numpad {
        max-width: 100%;
        padding: 0 20px;
      }
      
      .numpad button {
        width: 70px;
        height: 70px;
      }
      
      .worker-floating-panel {
        width: 95%;
        padding: 15px;
      }
    }
    
    /* Modo app para m√≥viles */
    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }
      
      .card {
        padding: 10px;
        border-radius: 10px;
      }
      
      #reader {
        min-height: 200px;
      }
      
      .lock-icon {
        font-size: 40px;
      }
      
      .pin-display {
        width: 180px;
        height: 45px;
        font-size: 20px;
      }
      
      .numpad button {
        width: 60px;
        height: 60px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla de bloqueo -->
  <div class="lock-screen" id="lockScreen">
    <div class="lock-icon">üîí</div>
    <div class="pin-display" id="pinDisplay">____</div>
    <div class="numpad">
      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button data-value="0">0</button>
      <button class="delete-btn" id="deletePin">Borrar</button>
    </div>
  </div>

  <header>
    TOKTOK ¬∑ Sistema de Registro de Asistencias
  </header>

  <div class="container">
    <!-- Esc√°ner -->
    <div class="card">
      <h3>Escanear credencial</h3>
      <div id="reader">
        <div class="scan-overlay" id="scanOverlay">Escaneo bloqueado temporalmente...</div>
      </div>
      <br>
      <label for="camaras">Seleccionar c√°mara:</label>
      <select id="camaras"></select>
      <br><br>
      <button id="iniciar">Iniciar C√°mara</button>
      <button id="detener">Detener C√°mara</button>
    </div>

    <!-- Resultado -->
    <div class="card">
      <h3>Registro de Asistencia</h3>
      
      <!-- Controles para horas extras -->
      <div class="extra-time-controls" id="extraControls">
        <div class="extra-time-info" id="extraTimeInfo">
          Primer escaneo: Registrar entrada de horas extras
        </div>
        <button id="cancelExtra">Cancelar Horas Extra</button>
      </div>
      
      <div class="worker-info" id="worker-info">
        <h4>Informaci√≥n del Trabajador</h4>
        <p><strong>Nombre:</strong> <span id="worker-name"></span></p>
        <p><strong>C√©dula:</strong> <span id="worker-ci"></span></p>
        <p><strong>Cargo:</strong> <span id="worker-position"></span></p>
      </div>
      
      <div id="resultado">Esperando escaneo...</div>
    </div>
  </div>

  <!-- Panel flotante para trabajador -->
  <div class="overlay" id="overlay"></div>
  <div class="worker-floating-panel" id="workerFloatingPanel">
    <button class="close-panel" id="closePanel">‚úï</button>
    <div class="worker-floating-header">
      <img src="https://placehold.co/70x70?text=Foto" alt="Foto" class="worker-floating-photo" id="floatingPhoto">
      <div class="worker-floating-details">
        <div class="worker-floating-name" id="floatingName"></div>
        <div class="worker-floating-info">
          CI: <span id="floatingCi"></span><br>
          Cargo: <span id="floatingPosition"></span>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="floating_event_type">Tipo de evento:</label>
      <select id="floating_event_type">
        <option value="entrada">Entrada</option>
        <option value="salida">Salida</option>
        <option value="extra">Horas Extra</option>
      </select>
    </div>
    
    <!-- Controles para horas extras en panel flotante -->
    <div class="extra-time-controls" id="floatingExtraControls">
      <div class="extra-time-info" id="floatingExtraTimeInfo">
        Primer escaneo: Registrar entrada de horas extras
      </div>
      <button id="floatingCancelExtra">Cancelar Horas Extra</button>
    </div>
    
    <div class="form-group">
      <label for="floating_notes">Notas (opcional):</label>
      <input type="text" id="floating_notes" placeholder="Ingrese notas adicionales">
    </div>
    
    <div class="worker-floating-controls">
      <button id="floatingRegistrar">Registrar Asistencia</button>
    </div>
  </div>

  <!-- Mensaje flotante de registro -->
  <div class="floating-message" id="floatingMessage"></div>

  <!-- Librer√≠a de escaneo QR -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script>
    // Variables globales
    let html5QrCode;
    let cameraId;
    let currentWorkerId = null;
    let currentWorkerData = null;
    let isScanningBlocked = false;
    let todayScans = {}; // Para controlar entrada/salida autom√°tica
    let extraSession = {
      active: false,
      startTime: null,
      workerId: null,
      workerName: null
    };
    const supabaseUrl = 'https://jnpxaunuqttylwheadsa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpucHhhdW51cXR0eWx3aGVhZHNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTU2NjQsImV4cCI6MjA3MTUzMTY2NH0.ZHix4M6SKvLW5CO8f13ToYq45EyNlAA7RuJ55vuoh9E';
    const CORRECT_PIN = "5445";
    let enteredPin = "";

    // Pantalla de bloqueo
    const lockScreen = document.getElementById('lockScreen');
    const pinDisplay = document.getElementById('pinDisplay');
    const deletePinBtn = document.getElementById('deletePin');
    
    // Panel flotante
    const workerFloatingPanel = document.getElementById('workerFloatingPanel');
    const overlay = document.getElementById('overlay');
    const closePanelBtn = document.getElementById('closePanel');
    const floatingRegistrarBtn = document.getElementById('floatingRegistrar');
    const floatingEventTypeSelect = document.getElementById('floating_event_type');
    const floatingExtraControls = document.getElementById('floatingExtraControls');
    const floatingExtraTimeInfo = document.getElementById('floatingExtraTimeInfo');
    const floatingCancelExtraBtn = document.getElementById('floatingCancelExtra');
    
    // Mensaje flotante
    const floatingMessage = document.getElementById('floatingMessage');
    
    // Overlay de bloqueo de escaneo
    const scanOverlay = document.getElementById('scanOverlay');
    
    // Inicializar teclado num√©rico
    document.querySelectorAll('.numpad button[data-value]').forEach(button => {
      button.addEventListener('click', () => {
        if (enteredPin.length < 4) {
          enteredPin += button.getAttribute('data-value');
          updatePinDisplay();
          checkPin();
        }
      });
    });
    
    deletePinBtn.addEventListener('click', () => {
      enteredPin = "";
      updatePinDisplay();
    });
    
    function updatePinDisplay() {
      pinDisplay.textContent = enteredPin.padEnd(4, '_');
    }
    
    function checkPin() {
      if (enteredPin.length === 4) {
        if (enteredPin === CORRECT_PIN) {
          lockScreen.classList.add('hidden');
          // Iniciar la c√°mara autom√°ticamente al desbloquear
          setTimeout(() => {
            cargarCamaras();
            checkStoredExtraSession();
          }, 500);
        } else {
          // PIN incorrecto
          pinDisplay.classList.add('error');
          setTimeout(() => {
            enteredPin = "";
            updatePinDisplay();
            pinDisplay.classList.remove('error');
          }, 1000);
        }
      }
    }
    
    // Cargar sesi√≥n de horas extras desde localStorage
    function checkStoredExtraSession() {
      const storedSession = localStorage.getItem('extraSession');
      if (storedSession) {
        const session = JSON.parse(storedSession);
        // Verificar si la sesi√≥n tiene menos de 24 horas
        const sessionTime = new Date(session.startTime);
        const now = new Date();
        const hoursDiff = Math.abs(now - sessionTime) / 36e5;
        
        if (hoursDiff < 24) {
          extraSession = session;
          floatingEventTypeSelect.value = 'extra';
          floatingExtraControls.style.display = 'block';
          floatingExtraTimeInfo.innerHTML = `
            Segundo escaneo: Registrar salida de horas extras<br>
            <small>Trabajador: ${extraSession.workerName}</small><br>
            <small>Inicio: ${formatTime(sessionTime)}</small>
          `;
        } else {
          // Eliminar sesi√≥n expirada
          localStorage.removeItem('extraSession');
        }
      }
    }
    
    // Guardar sesi√≥n de horas extras en localStorage
    function saveExtraSession() {
      if (extraSession.active) {
        localStorage.setItem('extraSession', JSON.stringify(extraSession));
      } else {
        localStorage.removeItem('extraSession');
      }
    }
    
    // Manejo de horas extras en panel flotante
    floatingEventTypeSelect.addEventListener('change', () => {
      if (floatingEventTypeSelect.value === 'extra') {
        floatingExtraControls.style.display = 'block';
        // Si ya hay una sesi√≥n activa, mostrar informaci√≥n de salida
        if (extraSession.active) {
          floatingExtraTimeInfo.innerHTML = `
            Segundo escaneo: Registrar salida de horas extras<br>
            <small>Trabajador: ${extraSession.workerName}</small><br>
            <small>Inicio: ${formatTime(new Date(extraSession.startTime))}</small>
          `;
        } else {
          floatingExtraTimeInfo.textContent = "Primer escaneo: Registrar entrada de horas extras";
        }
      } else {
        floatingExtraControls.style.display = 'none';
      }
    });
    
    floatingCancelExtraBtn.addEventListener('click', () => {
      // Cancelar la sesi√≥n de horas extras
      extraSession = {
        active: false,
        startTime: null,
        workerId: null,
        workerName: null
      };
      localStorage.removeItem('extraSession');
      floatingExtraControls.style.display = 'none';
      document.getElementById("worker-info").style.display = 'none';
      document.getElementById("resultado").innerText = "Sesi√≥n de horas extras cancelada";
      currentWorkerId = null;
    });
    
    function formatTime(date) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Mostrar mensaje flotante
    function showFloatingMessage(message, type) {
      floatingMessage.textContent = message;
      floatingMessage.style.display = 'block';
      floatingMessage.style.backgroundColor = type === 'success' ? 'rgba(0, 128, 0, 0.8)' : 'rgba(0, 0, 0, 0.8)';
      
      setTimeout(() => {
        floatingMessage.style.display = 'none';
      }, 2000);
    }
    
    // Bloquear escaneo temporalmente
    function blockScanning() {
      isScanningBlocked = true;
      scanOverlay.style.display = 'flex';
      
      setTimeout(() => {
        isScanningBlocked = false;
        scanOverlay.style.display = 'none';
      }, 2000);
    }

    // Mostrar panel flotante con datos del trabajador
    function showWorkerFloatingPanel(worker) {
      document.getElementById('floatingName').textContent = `${worker.nombres} ${worker.apellidos}`;
      document.getElementById('floatingCi').textContent = worker.ci;
      document.getElementById('floatingPosition').textContent = worker.cargo;
      
      // Si hay foto, mostrarla (asumiendo que el campo se llama 'foto_url')
      if (worker.foto_url) {
        document.getElementById('floatingPhoto').src = worker.foto_url;
      }
      
      // Configurar el tipo de evento seg√∫n la sesi√≥n activa
      if (extraSession.active) {
        floatingEventTypeSelect.value = 'extra';
        floatingExtraControls.style.display = 'block';
        floatingExtraTimeInfo.innerHTML = `
          Segundo escaneo: Registrar salida de horas extras<br>
          <small>Trabajador: ${extraSession.workerName}</small><br>
          <small>Inicio: ${formatTime(new Date(extraSession.startTime))}</small>
        `;
      } else {
        // Determinar autom√°ticamente si es entrada o salida
        const today = new Date().toDateString();
        const workerKey = `${worker.id}_${today}`;
        
        if (todayScans[workerKey]) {
          // Ya tiene entrada, entonces es salida
          floatingEventTypeSelect.value = 'salida';
        } else {
          // No tiene entrada, entonces es entrada
          floatingEventTypeSelect.value = 'entrada';
        }
        floatingExtraControls.style.display = 'none';
      }
      
      workerFloatingPanel.style.display = 'block';
      overlay.style.display = 'block';
    }
    
    // Cerrar panel flotante
    closePanelBtn.addEventListener('click', () => {
      workerFloatingPanel.style.display = 'none';
      overlay.style.display = 'none';
    });
    
    // Registrar desde panel flotante
    floatingRegistrarBtn.addEventListener('click', () => {
      registrarAsistencia();
    });

    async function cargarCamaras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        const select = document.getElementById("camaras");
        select.innerHTML = "";
        if (devices && devices.length) {
          devices.forEach(dev => {
            const option = document.createElement("option");
            option.value = dev.id;
            option.text = dev.label || `C√°mara ${select.length + 1}`;
            select.appendChild(option);
          });
          cameraId = devices[0].id;
        } else {
          alert("No se detectaron c√°maras.");
        }
      } catch (e) {
        console.error("Error al cargar c√°maras: ", e);
        alert("Error al cargar c√°maras.");
      }
    }

    // Funci√≥n para buscar trabajador por QR
    async function buscarTrabajador(qrId) {
      try {
        document.getElementById("resultado").innerHTML = '<span class="loading"></span> Buscando trabajador...';
        
        const response = await fetch(`${supabaseUrl}/rest/v1/workers?qr_id=eq.${qrId}&select=*`, {
          headers: {
            'apikey': supabaseKey,
            'Authorization': `Bearer ${supabaseKey}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Error en la b√∫squeda');
        }
        
        const workers = await response.json();
        
        if (workers && workers.length > 0) {
          const worker = workers[0];
          currentWorkerId = worker.id;
          currentWorkerData = worker;
          
          // Mostrar informaci√≥n del trabajador en panel flotante
          showWorkerFloatingPanel(worker);
          
          // Para horas extras, verificar si es el primer o segundo escaneo
          if (floatingEventTypeSelect.value === 'extra') {
            if (!extraSession.active) {
              // Primer escaneo - entrada de horas extras
              document.getElementById("resultado").innerHTML = '<span class="success">Listo para registrar entrada de horas extras</span>';
            } else {
              // Segundo escaneo - verificar que sea el mismo trabajador
              if (extraSession.workerId === currentWorkerId) {
                document.getElementById("resultado").innerHTML = '<span class="success">Listo para registrar salida de horas extras</span>';
              } else {
                document.getElementById("resultado").innerHTML = '<span class="error">Error: El trabajador no coincide con la sesi√≥n de horas extras</span>';
                floatingRegistrarBtn.disabled = true;
                return;
              }
            }
          } else {
            document.getElementById("resultado").innerHTML = '<span class="success">Trabajador encontrado</span>';
          }
          
          floatingRegistrarBtn.disabled = false;
        } else {
          document.getElementById("worker-info").style.display = 'none';
          document.getElementById("resultado").innerHTML = '<span class="error">No se encontr√≥ el trabajador</span>';
          floatingRegistrarBtn.disabled = true;
          currentWorkerId = null;
          currentWorkerData = null;
        }
      } catch (error) {
        console.error("Error al buscar trabajador:", error);
        document.getElementById("resultado").innerHTML = '<span class="error">Error al buscar trabajador</span>';
        floatingRegistrarBtn.disabled = true;
        currentWorkerId = null;
        currentWorkerData = null;
      }
    }

    // Funci√≥n para registrar asistencia
    async function registrarAsistencia() {
      if (!currentWorkerId) {
        alert("No hay un trabajador seleccionado");
        return;
      }
      
      const eventType = floatingEventTypeSelect.value;
      let notes = document.getElementById("floating_notes").value;
      const deviceTime = new Date().toISOString();
      
      // Manejo especial para horas extras
      if (eventType === 'extra') {
        if (!extraSession.active) {
          // Primer escaneo - entrada de horas extras
          extraSession = {
            active: true,
            startTime: new Date(),
            workerId: currentWorkerId,
            workerName: `${currentWorkerData.nombres} ${currentWorkerData.apellidos}`
          };
          
          // Guardar en localStorage
          saveExtraSession();
          
          // Actualizar la interfaz
          floatingExtraTimeInfo.innerHTML = `
            Segundo escaneo: Registrar salida de horas extras<br>
            <small>Trabajador: ${extraSession.workerName}</small><br>
            <small>Inicio: ${formatTime(extraSession.startTime)}</small>
          `;
          
          document.getElementById("resultado").innerHTML = '<span class="success">Entrada de horas extras registrada. Espere el segundo escaneo para salida.</span>';
          floatingRegistrarBtn.disabled = true;
          
          // Mostrar mensaje flotante
          showFloatingMessage('‚úÖ Entrada de horas extras registrada', 'success');
          
          // Cerrar el panel despu√©s de registrar
          setTimeout(() => {
            workerFloatingPanel.style.display = 'none';
            overlay.style.display = 'none';
          }, 2000);
          
          // No enviar al servidor todav√≠a, esperar el segundo escaneo
          return;
        } else {
          // Segundo escaneo - salida de horas extras
          const endTime = new Date();
          const startTime = new Date(extraSession.startTime);
          const duration = Math.round((endTime - startTime) / 1000 / 60); // Duraci√≥n en minutos
          
          // Agregar la duraci√≥n a las notas
          const hours = Math.floor(duration / 60);
          const minutes = duration % 60;
          notes = `Horas extras: ${hours}h ${minutes}m. ${notes}`.trim();
          
          // Reiniciar la sesi√≥n de horas extras
          extraSession = {
            active: false,
            startTime: null,
            workerId: null,
            workerName: null
          };
          localStorage.removeItem('extraSession');
        }
      }
      
      try {
        document.getElementById("resultado").innerHTML = '<span class="loading"></span> Registrando asistencia...';
        floatingRegistrarBtn.disabled = true;
        
        const response = await fetch(`${supabaseUrl}/rest/v1/attendance`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': supabaseKey,
            'Authorization': `Bearer ${supabaseKey}`
          },
          body: JSON.stringify({
            worker_id: currentWorkerId,
            event_type: eventType,
            notes: notes,
            device_time: deviceTime
          })
        });
        
        if (!response.ok) {
          throw new Error('Error al registrar asistencia');
        }
        
        // Actualizar el registro de escaneos del d√≠a
        const today = new Date().toDateString();
        const workerKey = `${currentWorkerId}_${today}`;
        
        if (eventType === 'entrada') {
          todayScans[workerKey] = true;
          showFloatingMessage('‚úÖ Entrada registrada', 'success');
        } else if (eventType === 'salida') {
          todayScans[workerKey] = false;
          showFloatingMessage('‚úÖ Salida registrada', 'success');
        }
        
        document.getElementById("resultado").innerHTML = '<span class="success">Asistencia registrada correctamente</span>';
        setTimeout(() => {
          document.getElementById("resultado").innerText = "Listo para otro escaneo";
          document.getElementById("worker-info").style.display = 'none';
          document.getElementById("floating_notes").value = "";
          
          // Reiniciar controles de horas extras si es necesario
          if (eventType === 'extra') {
            floatingExtraControls.style.display = 'none';
          }
          
          // Cerrar el panel
          workerFloatingPanel.style.display = 'none';
          overlay.style.display = 'none';
        }, 2000);
        
      } catch (error) {
        console.error("Error al registrar asistencia:", error);
        document.getElementById("resultado").innerHTML = '<span class="error">Error al registrar asistencia</span>';
        floatingRegistrarBtn.disabled = false;
      }
    }

    // Inicializar eventos
    document.getElementById("iniciar").addEventListener("click", () => {
      cameraId = document.getElementById("camaras").value;
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }
      html5QrCode.start(
        cameraId,
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        qrCodeMessage => {
          // Si el escaneo est√° bloqueado, ignorar
          if (isScanningBlocked) return;
          
          // Bloquear escaneo por 2 segundos
          blockScanning();
          
          document.getElementById("resultado").innerText = "‚úÖ QR Detectado: " + qrCodeMessage;
          buscarTrabajador(qrCodeMessage);
        },
        errorMessage => {
          console.warn("Escaneo en progreso: ", errorMessage);
        }
      ).catch(err => {
        console.error("Error al iniciar c√°mara: ", err);
      });
    });

    document.getElementById("detener").addEventListener("click", () => {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("resultado").innerText = "C√°mara detenida.";
          document.getElementById("worker-info").style.display = 'none';
          currentWorkerId = null;
        }).catch(err => {
          console.error("Error al detener c√°mara: ", err);
        });
      }
    });

    // Inicializar la aplicaci√≥n
    updatePinDisplay();
  </script>
</body>
</html>
